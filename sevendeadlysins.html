<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>七つの大罪 レーダーチャート診断（完全版）</title>
<meta name="description" content="七つの大罪（傲慢・強欲・嫉妬・憤怒・色欲・暴食・怠惰）を質問でスコア化し、レーダーチャート＋タイプ診断（動物・注意点・相性）を表示する自己理解ツール。" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
<!-- Chart.js v4（SRIなしで確実読込） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#f7f8fb; --fg:#0f172a; --muted:#64748b; --accent:#2563eb; --card:#ffffff; --border:#e5e7eb;
    --good:#16a34a; --bad:#dc2626; --warn:#d97706;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: "Meiryo UI","Yu Gothic UI","Hiragino Kaku Gothic ProN", system-ui, -apple-system, sans-serif;
    line-height:1.6;
  }
  header{padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
  header h1{margin:0; font-size:clamp(18px,2.6vw,22px)}
  header small{color:var(--muted)}
  main{max-width:1200px; margin:16px auto; padding:0 12px 56px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px 16px 18px;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
  }
  .card h2{margin:0 0 10px; font-size:18px}
  .card h3{margin:14px 0 8px; font-size:16px}
  .category{border:1px dashed var(--border); border-radius:12px; padding:12px; margin:10px 0; background:#fcfdff}
  .q{display:grid; grid-template-columns:1fr max-content; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #f1f5f9}
  .q:last-child{border-bottom:none}
  .range{display:flex; gap:6px}
  .range label{padding:4px 8px; border:1px solid var(--border); border-radius:8px; cursor:pointer; user-select:none; font-weight:600}
  input[type="radio"]{display:none}
  input[type="radio"]:checked + label{border-color:var(--accent); box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 22%, transparent);}
  .scale{display:flex; align-items:center; gap:6px; white-space:nowrap; color:var(--muted); font-size:12px}
  .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  button{
    border:1px solid var(--border); background:#fff; padding:9px 12px; border-radius:10px; cursor:pointer;
    font-weight:700;
  }
  button.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  button:disabled{opacity:.55; cursor:not-allowed}
  .muted{color:var(--muted); font-size:13px}
  canvas{width:100% !important; height:auto !important}
  .kpis{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:8px}
  @media (max-width:720px){ .kpis{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:480px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .k{background:#f8fafc; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center}
  .k .name{font-weight:800; font-size:12px}
  .k .val{font-size:20px}
  .legend{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px; margin-top:6px; font-size:13px; color:var(--muted)}
  @media (max-width:560px){ .legend{grid-template-columns:1fr} }
  .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#1e1b4b; font-weight:800; border:1px solid #dbeafe}
  .conf-wrap{display:flex; align-items:center; gap:10px; margin:8px 0 2px}
  .conf-bar{flex:1; height:10px; background:#eef2ff; border-radius:999px; overflow:hidden; border:1px solid #dbeafe}
  .conf-bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, #93c5fd, #2563eb);}
  .pair{display:flex; flex-wrap:wrap; gap:6px; margin:6px 0}
  .pill{border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-weight:700}
  .ok{background:#ecfdf5; border-color:#bbf7d0; color:#065f46}
  .ng{background:#fef2f2; border-color:#fecaca; color:#7f1d1d}
  footer{max-width:1200px; margin:0 auto; padding:12px; color:var(--muted); font-size:12px}
</style>
</head>
<body>
<header>
  <h1>七つの大罪 レーダーチャート診断 <small>（自己評価・教育/研究用途）</small></h1>
</header>

<main>
  <div class="grid">
    <!-- 左：質問票 -->
    <section class="card" aria-labelledby="q-title">
      <h2 id="q-title">質問に回答してください</h2>
      <p class="muted">各項目は<strong>1（全く当てはまらない）〜 5（非常に当てはまる）</strong>で自己評価。各カテゴリ3問、合計21問。</p>
      <form id="quiz"></form>
      <div class="toolbar">
        <button type="button" class="primary" id="calcBtn">採点してレーダーチャート表示</button>
        <button type="button" id="resetBtn">全てリセット</button>
        <button type="button" id="exportPngBtn" disabled>PNG保存</button>
        <button type="button" id="saveJsonBtn">JSON保存</button>
        <button type="button" id="loadJsonBtn">JSON読込</button>
        <button type="button" id="shuffleBtn">並び替え（再シャッフル）</button>
        <input type="file" id="jsonFile" accept="application/json" style="display:none" />
      </div>
      <p class="muted">※入力は自動でブラウザに保存。研究・診療で用いる場合は各施設の倫理・プライバシー指針に従ってください。</p>
    </section>

    <!-- 右：結果とチャート -->
    <section class="card" aria-labelledby="r-title">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2 id="r-title" style="margin:0">結果</h2>
        <span id="typeBadge" class="badge" aria-live="polite">タイプ：—</span>
      </div>

      <div class="conf-wrap">
        <div class="muted" style="min-width:84px">自信度</div>
        <div class="conf-bar" aria-label="自信度"><i id="confFill"></i></div>
        <div id="confVal" style="min-width:42px;text-align:right" class="muted">0%</div>
      </div>

      <div class="kpis" id="kpis"></div>
      <canvas id="radar" aria-label="七つの大罪レーダーチャート" role="img"></canvas>

      <div class="legend">
        <div>スコアは0〜100に正規化（1→0、5→100）。高いほど傾向が<strong>強い</strong>。</div>
        <div>所見は<strong>上位差</strong>・<strong>親和性</strong>・<strong>ばらけ具合</strong>（エントロピー）でタイプを自動判定。</div>
      </div>

      <h3>診断レポート</h3>
      <div id="insight" class="muted">採点するとここに詳細レポートが表示されます。</div>

      <h3 style="margin-top:14px">相性</h3>
      <div id="compatibility">
        <div class="pair">
          <span class="pill ok">相性が良い：—</span>
          <span class="pill ng">相性が悪い：—</span>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  © 2025 七つの大罪レーダー | 本ツールは医療的診断を提供するものではありません。自己理解・教育・研究用途を想定しています。
</footer>

<script>
/* ========= 基本設定 ========= */
const CATEGORIES = [
  { key: "pride",   name: "傲慢",   desc: "自己を過度に高く評価し他者を見下す傾向" },
  { key: "greed",   name: "強欲",   desc: "富・権力・名誉を過度に求める傾向" },
  { key: "envy",    name: "嫉妬",   desc: "他者の成功や幸福を妬む傾向" },
  { key: "wrath",   name: "憤怒",   desc: "理性を失うほど怒りを募らせる傾向" },
  { key: "lust",    name: "色欲",   desc: "性的欲望に過度に支配される傾向" },
  { key: "gluttony",name: "暴食",   desc: "食や飲みに対して過度に耽る傾向" },
  { key: "sloth",   name: "怠惰",   desc: "善い行い・責務を先延ばしにする傾向" },
];
const QUESTIONS = {
  pride: ["他人の助言より自分の判断を優先しがちだ。","自分は平均より有能だと頻繁に感じる。","謝罪や非を認めるのが苦手だ。"],
  greed: ["お金や成果を得ても、すぐに次の獲得を考える。","損得勘定で物事を判断しがちだ。","評価や称賛を強く求める。"],
  envy: ["SNSで他人の成功を見ると気分が沈む。","同僚の昇進・表彰に複雑な感情を抱くことが多い。","自分より恵まれた人に苛立ちを感じる。"],
  wrath:["小さな出来事で強くイラつくことがある。","過去に対して復讐心が消えにくい。","運転や行列などで怒りを抑えにくい。"],
  lust: ["仕事中や学業中に性的な空想で注意が逸れることがある。","出会い系／アダルトコンテンツを衝動的に消費しがちだ。","相手の同意や尊厳より自分の欲求を優先しそうになる。"],
  gluttony:["満腹でもさらに食べたり飲んだりすることがある。","ストレス時に過食・過飲に走りやすい。","栄養バランスより即時の満足を優先しがちだ。"],
  sloth:["すべきことを後回しにして罪悪感を抱くことが多い。","目標に着手するまでに無駄な時間を費やしがちだ。","健康や学習など長期的益の行動を継続できない。"]
};
const STORAGE_KEY = "seven_sins_quiz_v2";

/* ========= UI生成（ランダム表示対応） ========= */
const STORAGE_KEY = "seven_sins_quiz_v3"; // v3（ランダム対応）

// 1) qidのフラット化
function makeItemList(){
  // {qid, catKey, catName, idx, text}
  const items = [];
  CATEGORIES.forEach(cat=>{
    QUESTIONS[cat.key].forEach((text, idx)=>{
      items.push({ qid:`${cat.key}_${idx}`, catKey:cat.key, catName:cat.name, idx, text });
    });
  });
  return items;
}

// 2) シャッフル（Fisher–Yates）
function shuffleInPlace(arr){
  for(let i=arr.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// 3) 描画：カテゴリ名は出さず、連番＋設問文＋5段階
let CURRENT_ITEMS = []; // 現在の表示順
const quizEl = document.getElementById("quiz");

function buildQuizRandom(){
  CURRENT_ITEMS = makeItemList();
  shuffleInPlace(CURRENT_ITEMS);
  renderQuizFromItems();
  // 既存保存を復元
  applySavedAnswers();
}

function renderQuizFromItems(){
  quizEl.innerHTML = "";
  CURRENT_ITEMS.forEach((it, i)=>{
    const row = document.createElement("section");
    row.className = "category";
    const name = it.qid; // ラジオのnameはqid（順番変わっても不変）
    const radios = [1,2,3,4,5].map(v=>{
      const id = `${name}_${v}`;
      return `
        <input type="radio" name="${name}" id="${id}" value="${v}">
        <label for="${id}">${v}</label>
      `;
    }).join("");
    row.innerHTML = `
      <div class="q" style="border-bottom:none">
        <div><strong>Q${i+1}.</strong> ${it.text}
          <div class="scale" aria-hidden="true"><span>1</span> 全く当てはまらない 〜 <span>5</span> 非常に当てはまる</div>
        </div>
        <div class="range" role="radiogroup" aria-label="Q${i+1}">
          ${radios}
        </div>
      </div>
    `;
    quizEl.appendChild(row);
  });
}

/* ========= 入出力・保存（qidベース） ========= */
function readAnswers(){
  // 返り値は { qid: 1..5 or null }
  const out = {};
  CURRENT_ITEMS.forEach(it=>{
    const el = quizEl.querySelector(`input[name="${it.qid}"]:checked`);
    out[it.qid] = el ? Number(el.value) : null;
  });
  return out;
}
function isCompleteByQid(map){
  return Object.values(map).every(v => v !== null);
}
function saveToLocal(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(readAnswers())); }catch(e){}
}
function loadFromLocalRaw(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function applySavedAnswers(){
  const saved = loadFromLocalRaw();
  if(!saved) return;
  CURRENT_ITEMS.forEach(it=>{
    const v = saved[it.qid];
    if(v==null) return;
    const el = document.getElementById(`${it.qid}_${v}`);
    if(el) el.checked = true;
  });
}
quizEl.addEventListener("change", saveToLocal);

/* ========= スコア計算（qid→カテゴリへ逆集計） ========= */
function computeScoresFromQidMap(qMap){
  // {catKey: [ three values 1..5 ]} を組み直し
  const bucket = {};
  CATEGORIES.forEach(c=> bucket[c.key] = []);
  // qid: pride_0 のような形式
  Object.entries(qMap).forEach(([qid, v])=>{
    if(v==null) return;
    const catKey = qid.split("_")[0];
    if(bucket[catKey]) bucket[catKey].push(v);
  });
  // 3問揃っていない場合はnullで埋める（未回答扱い）
  CATEGORIES.forEach(c=>{
    while(bucket[c.key].length < QUESTIONS[c.key].length) bucket[c.key].push(null);
  });

  // 完全性チェック
  const complete = Object.values(bucket).every(arr => arr.every(v => v !== null));
  if(!complete) return { complete:false, scores:null };

  // 平均→0-100正規化
  const scores = {};
  CATEGORIES.forEach(cat=>{
    const arr = bucket[cat.key];
    const avg = arr.reduce((a,b)=>a+b,0) / arr.length; // 1..5
    const norm = Math.round(((avg - 1)/4)*100);
    scores[cat.key] = { avg, norm };
  });
  return { complete:true, scores };
}

/* ========= 初期ロード & 再シャッフル ========= */
buildQuizRandom();
document.getElementById("shuffleBtn").addEventListener("click", ()=>{
  // 今の回答を保持したまま並び替え
  const saved = loadFromLocalRaw() || {};
  buildQuizRandom();
  // 直前の保存を反映（applySavedAnswers内でも復元するが、念押し）
  CURRENT_ITEMS.forEach(it=>{
    const v = saved[it.qid];
    if(v==null) return;
    const el = document.getElementById(`${it.qid}_${v}`);
    if(el) el.checked = true;
  });
});

/* ========= KPI/所見の呼び出しは既存関数を使用 ========= */
// 既存の renderKPIs(scores), drawChart(scores), renderInsight(scores) をそのまま利用

/* ========= PNG/JSON（既存の処理を流用するため、保存/読込をqidマップに変更） ========= */
document.getElementById("saveJsonBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(readAnswers(), null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  const ts = new Date().toISOString().replace(/[:.]/g,"-");
  a.href = URL.createObjectURL(blob);
  a.download = `seven-sins-answers-${ts}.json`;
  a.click();
};
document.getElementById("loadJsonBtn").onclick = ()=> document.getElementById("jsonFile").click();
document.getElementById("jsonFile").addEventListener("change", (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result); // {qid: value}
      // 既存チェックを一旦クリア
      quizEl.querySelectorAll('input[type="radio"]:checked').forEach(el=> el.checked=false);
      // 反映（UI上に存在していないqidは無視）
      Object.entries(data).forEach(([qid, v])=>{
        const el = document.getElementById(`${qid}_${v}`);
        if(el) el.checked = true;
      });
      // 保存
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
    }catch(err){ alert("JSONの形式が不正です。"); }
  };
  reader.readAsText(file);
});

/* ========= 採点とリセット（計算部をqidマップ対応へ） ========= */
document.getElementById("calcBtn").addEventListener("click", ()=>{
  const qMap = readAnswers();
  const { complete, scores } = computeScoresFromQidMap(qMap);
  if(!complete){ alert("未回答があります。全ての質問に回答してください。"); return; }
  renderKPIs(scores);
  drawChart(scores);
  renderInsight(scores);
});
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(!confirm("全回答をリセットしますか？")) return;
  quizEl.querySelectorAll('input[type="radio"]:checked').forEach(el=> el.checked=false);
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  document.getElementById("kpis").innerHTML = "";
  document.getElementById("insight").textContent = "採点するとここに詳細レポートが表示されます。";
  document.getElementById("typeBadge").textContent = "タイプ：—";
  document.getElementById("confFill").style.width = "0%";
  document.getElementById("confVal").textContent = "0%";
  if(radarChart){ radarChart.destroy(); radarChart = null; }
  document.getElementById("exportPngBtn").disabled = true;

  // 並び順もリセット（新しくシャッフル）
  buildQuizRandom();
});

/* ========= 初期表示：空グラフ ========= */
(function initEmptyRadar(){
  if (typeof Chart === "undefined") {
    alert("Chart.jsの読み込みに失敗しました。ネットワークや拡張機能を確認してください。");
    return;
  }
  const empty = {}; CATEGORIES.forEach(c => empty[c.key] = { avg: 1, norm: 0 });
  renderKPIs(empty);
  drawChart(empty);
  document.getElementById("insight").textContent = "質問に回答して「採点」を押すとタイプ診断が表示されます。";
})();
</script>
</body>
</html>
