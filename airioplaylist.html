<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AirIo Apollo Highlight Player</title>
</head>
<body>
  <h2>AirIo Apollo Highlight Player</h2>
  <div id="player"></div>

  <script>
    // ★再生リスト：動画ID・開始位置・再生時間（秒）
    const playSegments = [
      { videoId: "x0yocJ7M1A4", start: 46, duration: 35 }, // Deep Breath
      { videoId: "qug0wZTMaWM", start: 43, duration: 35 }, // Innocent
      { videoId: "8FK2DDy2hIw", start: 82, duration: 35 }, // Scarlet Loafers
      { videoId: "KLrBUfB7izw", start: 33, duration: 35 }, // みんなその統計、間違ってますよー
      { videoId: "P4DLSdeyhjs", start: 40, duration: 35 }, // ちょっと君その検定、おかしいんじゃな〜い？
      { videoId: "cwNJ50lPBaY", start: 20, duration: 35 }, // レジの横で待ってるよ
      { videoId: "OYuf9rKviAU", start: 34, duration: 35 }, // つながりの奇跡
    ];

    let player;
    let segmentTimer;
    let isSegmentPlaying = false;

    // YouTube IFrame API 読み込み
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    // プレイヤー準備完了後の処理
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '390',
        width: '640',
        playerVars: {
          autoplay: 1, // 自動再生を有効に
          mute: 1      // ミュートで再生（自動再生制限を回避）
        },
        events: {
          onReady: () => {
            player.mute(); // 念のためミュート設定を強制
            playRdandomSegment(); // 最初の再生
          },
          onStateChange: onPlayerStateChange
        }
      });
    }
  
    // 動画の再生状態が変わったときの処理
    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING && !isSegmentPlaying) {
        isSegmentPlaying = true;
        const currentSegment = player.getVideoData();
        const currentIndex = getCurrentSegmentIndex(currentSegment.video_id);
        if (currentIndex !== -1) {
          const duration = playSegments[currentIndex].duration;
          segmentTimer = setTimeout(() => {
            playRandomSegment();
          }, duration * 1000);
        } else {
          // 万一 video_id が一致しなければ即再切り替え
          playRandomSegment();
        }
      }
    }

    // ランダムに1つ選んで再生
    function playRandomSegment() {
      clearTimeout(segmentTimer);
      isSegmentPlaying = false;
      const index = Math.floor(Math.random() * playSegments.length);
      const segment = playSegments[index];
      player.loadVideoById({
        videoId: segment.videoId,
        startSeconds: segment.start
      });
    }

    // 現在の videoId に一致するインデックスを返す
    function getCurrentSegmentIndex(videoId) {
      return playSegments.findIndex(seg => seg.videoId === videoId);
    }
  </script>
</body>
</html>
